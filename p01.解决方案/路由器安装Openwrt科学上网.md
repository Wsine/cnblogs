# 路由器安装Openwrt && 科学上网

## 前言

对于给路由器刷系统，肯定是有风险的，敢于承担风险的才开始动手。

Openwrt其实也是一款嵌入式Linux系统，对于闪存大小也是有一定的要求的，建议采用有前人尝试过的路由器。我使用的是和Openwrt比较搭的Netgear WNDR3800路由器，处理器和存储空间都有很大的折腾空间。

## 刷机过程

### 路由器降级

有时候厂商会禁止用户刷第三方系统，在特定的版本开始添加过滤规则，识别刷机文件是否自家的系统。例如，Netgear在1.0.0.40版本开始禁止刷第三方系统。因此，可以采用降级的方式绕开。

首先去厂商官网找路由器的低版本固件，下载。在Netgear的官网中找型号是WNDR3800，版本是1.0.0.16的固件，文件名`WNDR3800-V1.0.0.16.img`。

连上路由器，进入路由器的管理页面，网址在路由器背面有贴纸说明，一般为192.168.1.1。找到系统->升级->从文件升级，点击选择文件找到刚刚下载的`WNDR3800-V1.0.0.16.img`,点击上传即可。

### 刷Openwrt固件

在Openwrt的wiki页面中找到自己的设备型号，里面有下载链接，需要英文比较好，多次跳转。例如我找到的下载文件为：

- openwrt-15.05.1-ar71xx-generic-wndr3800-squashfs-sysupgrade.bin
- openwrt-15.05-ar71xx-generic-wndr3800-squashfs-factory.img

bin文件是给Openwrt系统升级使用的，这里我们不需要使用。从厂商系统刷Openwrt，使用img文件即可。同样，连上路由器，进入路由器的管理页面，网址在路由器背面有贴纸说明，一般为192.168.1.1。找到系统->升级->从文件升级，点击选择文件找到刚刚下载的`openwrt-15.05-ar71xx-generic-wndr3800-squashfs-factory.img`,点击上传即可。

然后，Openwrt系统就刷好了。管理页面的地址可能会变，不过也是长192.168.x.1的样子，多试一下就好了。

**注意，ar71xx指的是处理器芯片型号。**不是所有的设备都有Openwrt的官方支持，不过一般芯片型号相同也是能刷进去的，后续折腾机器装软件也是需要这个处理器芯片型号的。请自行搜索自己设备的对应型号。

### 刷机模式

如果厂商禁止刷第三方系统，原厂系统最低版本号也限制没办法降级，则可以使用刷机模式刷系统。和安卓手机的刷机模式类似，按住路由器背面的Reset按钮（需要用东西戳），再打开路由器开关，等待路由器指示灯从不断闪烁变成特定模式的常亮后，即可松手，路由器进入了刷机模式。

连上路由器，使用路由器刷机软件（没找到官网就不贴链接了），使用相应的img文件，刷入即可。界面小白也能看懂。刷成功后断电重启即可。

## 科学上网

### 准备工作

我使用的是Shadowsocks的方式，避免被查水表你不要问我是什么，你没有天线我没办法跟你解释。我就假设你知道了。

首先准备下面的一些文件：

- shadowsocks-libev-spec_2.1.4-1_ar71xx.ipk
- ChinaDNS_1.3.1-1_ar71xx.ipk
- luci-app-shadowsocks-spec_1.3.0-1_all.ipk
- luci-app-chinadns_1.3.1-1_all.ipk
- accelerated-domains.china.conf

**版本号什么的不重要，处理器芯片型号才重要。**版本号能用就行，不行就多试试几个版本号，一般我都直接下最新版本的，在forget.net（TODO 网址有误）可以搜索下载。

`shadowsocks-libev-spec_2.1.4-1_ar71xx.ipk`是主程序文件，不解释。
`ChinaDNS_1.3.1-1_ar71xx.ipk`是解析DNS用的，避免国内网站访问过慢，对国内网站直接访问，对国外网站科学访问。
`luci-app-******_all.ipk`是给Openwrt的管理页面上增加网页端的配置界面用的，如果你喜欢一直用命令行配置可以不装这个
`accelerated-domains.china.conf`保存一些需要加速的域名的配置文件

### 开始动手

在终端中将下载的文件上传的路由器中，使用scp大法。（不会的可以用U盘挂载，但这个太low我不教）

`# scp local_file root@remote_ip:/tmp`

local_file指的就是刚刚下载的文件，remote_ip就是登陆管理页面的地址，统一上传的`/tmp`目录中即可，哪怕忘记它会自己帮你删除的。

然后，ssh连接登陆路由器，并将这些包安装到路由器中，先装程序主体，再装luci开头的文件。

```
# ssh root@remote_ip
# cd /tmp
# opkg install ******.ipk
```

装完回到路由器管理页面，找到服务（Service）就好了，剩下的图形化界面看着把内容填一下就好了。当然还有透明代理UDP转发DNS动态更新PAC模式匹配一大堆乱七八糟的你没有天线我没办法跟你解释。嗯，科学上网这里很水，免得查水表，逃了。。。
